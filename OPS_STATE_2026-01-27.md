# WildDuck Ops State (2026-01-27)

This snapshot documents the current operational state and recent changes applied on the live host `wildduck.tusker.net.au`.

## Monitoring & Stats

### `/stats` endpoint (basic auth)
- URL: `https://wildduck.tusker.net.au/stats`
- Auth: Basic (user: `tusker`)
- Backend: `wildduck-stats` container (Flask), reads Docker + service health/latency.
- Metrics shown:
  - container state/health/uptime/restarts
  - Mongo/Redis latency + op counters rate
  - ZoneMTA `/metrics`
  - Rspamd `/stat` + `/metrics`
  - Webmail HTTP check
  - OpenSearch cluster health

### Prometheus + Grafana
- Grafana: `https://wildduck.tusker.net.au/grafana`
- Prometheus scrape targets:
  - node_exporter, cadvisor
  - mongodb_exporter, redis_exporter
  - zonemta `/metrics`
- Dashboards provisioned:
  - WildDuck Host
  - WildDuck Containers
  - WildDuck Services
- Alert rules enabled:
  - InstanceDown
  - DiskSpaceLow
  - Mongo/Redis exporter down
  - Prometheus target down
  - ContainerStale

## Service Hardening / Recovery
- Mongo, Redis, WildDuck now have Docker healthchecks.
- Auto-heal container deployed (restarts unhealthy labeled containers).
- Fail2ban jail `wildduck-legacytls` added for legacy TLS probes in Docker logs.

## Mail Stack Fixes
- ZoneMTA uses Traefik-provided certs via `haraka-cert-sync`.
- Added ZoneMTA WildDuck plugin ACME config with autogenerate disabled.
- Replaced `__MAIL_HOSTNAME__` placeholders in live configs.
- Webmail TOML fixed (`__WEBMAIL_DOMAINS__` replaced with `['tusker.org']`).
- Added address `tpm@tusker.net.au` to user `tpm`.

## Rspamd
- Spamhaus DQS token injected in local config.
- Controller listener bound internally on `0.0.0.0:11334` for metrics scraping.

## Notes
- Legacy TLS probes observed from `143.244.48.199` (DataPacket). Fail2ban jail created to auto-ban on recurrence.
- ZoneMTA API now binds `0.0.0.0` to allow Prometheus and stats checks.
- Grafana uses login (no Traefik basic auth).

## Files touched on the server (summary)
- `/root/wildduck-dockerized/docker-compose.yml`
- `/root/wildduck-dockerized/monitoring/prometheus.yml`
- `/root/wildduck-dockerized/monitoring/prometheus.rules.yml`
- `/root/wildduck-dockerized/monitoring/grafana/*`
- `/root/wildduck-dockerized/config/zone-mta/*`
- `/root/wildduck-dockerized/config/rspamd/*`
- `/root/wildduck-dockerized/config/wildduck*/*`
- `/root/wildduck-dockerized/config/haraka/*`

